{"posts":[{"title":"Mnifilter Learning Note","content":"Notice This blog only description something hard found knowledge for me for minifilter. So has something writing so brief,but you can easy found there online I'm suggest you can wtach the example by me if you has just learning minifilter https://github.com/DerKiChong/BasicMiniFilter It can help you learning it soon. MiniFilter Overview FilterManger FilterManger is a component of windows,you can found it in â€ªC:\\Windows\\System32\\drivers\\fltMgr.sys Altitude Minifilter driver has a concept called altitude,it determine the minifilter driver receive the I/O operation in I/O stack of windows CallBack Minifilter has 2 series of register callback : pre and post Pre callback recive the data when io request completed before Post callback recive the data when io request completed Later In PreCallBack,call order of altitude from highest to lowest In PostCallBack,call order of altitude from lowest to highest Context Minifilter context just a buffer attach in object as well as minifilter context has types,The types determine by context attach object types. The purpose of the Minifilter Context is to saving and taking for data in particular object. Files (Windows Vista and later) windows will create a file context when file open.But just has only one,Not matter you open many times.And file context will not destroy instantly When the close count is zero. Instances Instance is an attachment in minifilter driver as well as it is at particular altitude in the volume. Binded in instances of context,we called it instance context Streams (File Control Block) File Control Block(FCB) is a structure for description and control file. One file correspond for one for FCB imagine a scene: When Windows loading file from disk to memory,File data is scatteringin physical disk's piece So we need using the FCB to recording the map for File data and physical disk's piece. Stream handles (File Objects) Binded in file objects of context,we called it Stream handles Context Transactions (Windows Vista and later) I don't not what is shit for it.I can't found it's concept on online.fucking Microsoft dos. Volumes I understand it as our virtual disk,just like the C:\\ D:\\ E:\\ .... This Context Alloc the Memory only can use NoPagePool tag Coding Environment #include &lt;fltkernel.h&gt; properties -&gt; linker -&gt; input -&gt; add $(DDK_LIB_PATH)fltMgr.lib Inf File The major purpos for inf file in minifilter is determining the instance for description of minifilter driver. If Inf File has not install,you can't start the minifilter only if you are writing registry for instance of minifilter by youself. The How to writing the Inf file by youself. I usually copy the minifilter examples of Microsoft for inf file. https://github.com/microsoft/Windows-driver-samples/tree/main/filesys/miniFilter The if you are interested in writing for inf file,Then you can see the Microsoft docs https://learn.microsoft.com/en-us/windows-hardware/drivers/ifs/creating-an-inf-file-for-a-minifilter-driver If you want to know how to writing registry to install minifilter,you can watch the example by me. StartMinifilter There are two crucial functions for minifilter start NTSTATUS FLTAPI FltRegisterFilter( [in] PDRIVER_OBJECT Driver, [in] const FLT_REGISTRATION *Registration, [out] PFLT_FILTER *RetFilter ); NTSTATUS FLTAPI FltStartFiltering( [in] PFLT_FILTER Filter ); We can got a something simple from the above information. We just alloc the structure for FLT_REGISTRATION type and fill it,Then stuff it to FltRegisterFilter and the FltStartFiltering. The FLT_REGISTRATION is difference in win7 and win8 later system. The Win7 has not the member for SectionNotificationCallback I suggest you define 2 FLT_REGISTRATION structure by youself,Then determine the structure according the difference system Watch that the definition with FLT_REGISTRATION typedef struct _FLT_REGISTRATION { USHORT Size; USHORT Version; FLT_REGISTRATION_FLAGS Flags; CONST FLT_CONTEXT_REGISTRATION *ContextRegistration; CONST FLT_OPERATION_REGISTRATION *OperationRegistration; PFLT_FILTER_UNLOAD_CALLBACK FilterUnloadCallback; PFLT_INSTANCE_SETUP_CALLBACK InstanceSetupCallback; PFLT_INSTANCE_QUERY_TEARDOWN_CALLBACK InstanceQueryTeardownCallback; PFLT_INSTANCE_TEARDOWN_CALLBACK InstanceTeardownStartCallback; PFLT_INSTANCE_TEARDOWN_CALLBACK InstanceTeardownCompleteCallback; PFLT_GENERATE_FILE_NAME GenerateFileNameCallback; PFLT_NORMALIZE_NAME_COMPONENT NormalizeNameComponentCallback; PFLT_NORMALIZE_CONTEXT_CLEANUP NormalizeContextCleanupCallback; #if FLT_MGR_LONGHORN PFLT_TRANSACTION_NOTIFICATION_CALLBACK TransactionNotificationCallback; PFLT_NORMALIZE_NAME_COMPONENT_EX NormalizeNameComponentExCallback; #endif // FLT_MGR_LONGHORN #if FLT_MGR_WIN8 PFLT_SECTION_CONFLICT_NOTIFICATION_CALLBACK SectionNotificationCallback; #endif // FLT_MGR_WIN8 } FLT_REGISTRATION, *PFLT_REGISTRATION; Notice the Version of member It claim must be FLT_REGISTRATION_VERSION in Microsoft docs. but when you go to definition with FLT_REGISTRATION_VERSION and you can found this definition is FLT_REGISTRATION_VERSION_0202 or FLT_REGISTRATION_VERSION_0203(determine for you WDK version ) The anything member you can found their description in Microsoft docs. StopMinifilter Calling the simple function just working! VOID FLTAPI FltUnregisterFilter( [in] PFLT_FILTER Filter ); Other IRPIRP_MJ_ACQUIRE_FOR_SECTION_SYNCHRONIZATION of I/O operation code correspond the NtCreateSection,Then you can intercept CreateProcess and Dll inject in this. If you want to oper file in minifilter callback you must use the Fltxxx series function,such as FltWriteFile...... Thank for https://community.osr.com/discussion/181155 https://learn.microsoft.com/en-us/windows-hardware/drivers/ifs/filter-manager-concepts https://blog.csdn.net/youyou519/article/details/90768197 https://github.com/microsoft/Windows-driver-samples/tree/main/filesys/miniFilter ","link":"https://DerKiChong.github.io/post/TVgh_X2nF/"}]}